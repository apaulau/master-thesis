% -*- root: thesis.tex -*-
\newcommand{\inp}[1]{\input{../out/#1}}
\newcommand{\characteristic}[2]{\inp{#1/characteristics/#2}}
\newcommand{\descriptive}[2]{\inp{#1/descriptive/#2}}
\newcommand{\test}[3]{\inp{#1/test/#2/#3}}
\newcommand{\normaldistr}{$\mathcal{N}(\descriptive{original}{mean}, \descriptive{original}{variance})$}

\newpage

\chapter{Анализ временного ряда в пакете R}

\section{Детерминированный подход} % (fold)
\label{sec:determenistic}

\subsection{Описательные статистики и первичный анализ данных} % (fold)
\label{sec:basis}

В качестве исходных данных примем выборку из полученной от учебно-научного центра базы данных, путём отбора наблюдений в июле месяце за период с 1975 по 2012 год. Выборка представлена в приложении \ref{c:source_data} в таблице \ref{table:source}. Графически исходные данные представлены на рисунке \ref{img:input}.

\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/source.png}}
\caption{График исходных данных}
\label{img:input}
\end{figure}

Следует отметить, что для непосредственного исследования были использованы наблюдения с 1975 по 2009 год. Наблюдения за 2010-2012 годы были намеренно исключены из исследования в целях дальнейшего оценивания результатов анализа и прогнозирования. Заметим, что работа, представленная в параграфах \ref{sec:basis}--\ref{sec:regr_analysis}, была также проделана и для всей выборки. Так как поведение целой выборки сохранилось в уменьшенной, то, без потери общности, будем считать её исходной.

Начнём исследование временного ряда с вычисления описательных статистик. \textbf{R} предоставляет в пакете \textit{base} различные функции для расчетов базовых статистик. Также, в различных пакетах можно найти другие интересующие функции, как статистические, так и математические. Но в целях удобства, компактности и контроля за функциональностью на основе \cite{Eliseeva1995, Cramer1997} мной был написан модуль \textit{dstats}, представленный в приложении \ref{c:listings} листинге \ref{lst:dstats}. Данный модуль позволяет вычислять все рассмотренные в данной работе описательные статистики. Полученные результаты для исходных данных отображены в таблице \ref{table:dstats}.

\input{../out/original/dstats.tex}

Рассмотрим подробнее некоторые полученные статистики.

Как видно из таблицы, \textit{средняя} температура в июле месяце за период с 1975 по 2009 составляет приблизительно 20ºС.

\textit{Коэффициент вариации} в нашем случае равен $ \descriptive{original}{coef-var} $. Из этого следует, что выборку можно считать однородной, так как полученное значение является меньшим 33\% \cite{Eliseeva1995}.

\textit{Коэффициент асимметрии} --- мера симметричности распределения. Полученное значение: $ \descriptive{original}{skew} $. Данное значение говорит о незначительной правосторонней асимметрии распределения. То есть о том, что выборочное распределение можно считать близким к симметричному \cite{Bulmer1979Principles}.

\textit{Коэффициент эксцесса} в рассматриваемом случае равен $ \descriptive{original}{kurtosis}$. Так как коэффициент эксцесса нормального распределения равен $ 0 $, то в данном случае можно говорить о пологости пика распределения выборки по отношению к нормальному распределению \cite{Bulmer1979Principles}.

С помощью тестовых статистик для коэффициента асимметрии и эксцесса \cite[с.85-89]{Cramer1997}, проверим значимость полученных значений для генеральной совокупности. Для этого в модуле \textit{dstats} мной реализованы функции \textit{dstats.test.skew} и \textit{dstats.test.kurtosis}:

Полученная тестовая статистика для коэффициента асимметрии:
\begin{equation*}
	Z_{A_S} = \frac{A_S}{SES} = \descriptive{original}{test-skew}.
\end{equation*}
Данное значение попадает под случай $\vert Z_{A_S} \vert \le 2$, а значит, выборочный коэффициент асимметрии не является значимым. Из чего, в свою очередь, следует, что по нему нельзя судить о коэффициенте асимметрии генеральной совокупности \cite[с.85]{Cramer1997}.

Полученная тестовая статистика для коэффициента эксцесса:
\begin{equation*}
	Z_K = \frac{K}{SEK} = \descriptive{original}{test-kurtosis}.
\end{equation*}
Данное значение попадает под случай $\vert Z_K \vert \le 2$, а значит, в данном случае выборочный коэффициент эксцесса не является значимым и нельзя ничего сказать о коэффициенте эксцесса генеральной совокупности \cite[с.89]{Cramer1997}.

% TODO: стоит переписать, т.к. эксцесс получился не очень и убрали параграф с отдельно ОС
Из полученных результатов следует отметить, что коэффициенты асимметрии и эксцесса, указывают на близость выборочного распределения к нормальному закону. Но при этом, из-за недостаточного объёма выборки, по этим коэффициентам нельзя судить о соответствующих коэффициентах генеральной совокупности.

В \textbf{R} можно найти различные пакеты, позволяющие строить разнообразные гистограммы, диаграммы рассеяния, вероятностные графики, линейные графики, диаграммы диапазонов, размахов, круговые диаграммы, столбчатые диаграммы, последовательные графики и т.д., позволяющие увидеть специфику данных. В процессе работы в пакете \textbf{R} использовались источники \cite{Kabacoff2009R, Teetor2011RCook, Chang2012RGraph}.

С помощью функции пакета \textit{ggplot2} построим гистограмму для отображения вариационного ряда исходных данных \cite{Chang2012RGraph}. Гистограммы позволяют увидеть, как распределены значения переменных по интервалам группировки, то есть как часто переменные принимают значения из различных интервалов. А также, что бывает более важным, повзоляет сделать предположение о разновидности распределения. Для вычисления интервалов разбиения воспользуемся \textit{формулой Стерджеса}. Из \cite{Sturges1926Choice} количество интервалов разбиения рассчитывается по формуле:
\begin{equation}
\label{eq:sturges}
	k = \lceil log_{2}n \rceil + 1 = \lceil log_{2} \characteristic{original}{n} \rceil + 1 = \characteristic{original}{sturges}.
\end{equation}

Так как по гистограмме можно визуально предположить близость выборочного распределения к нормальному распределению, нанесём на график кривую плотности нормального распределения. Построенная гистограмма отображена на рисунке \ref{img:histogram_fitted}.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/original/histogram.png}}
\caption{Гистограмма наблюдаемых температур с кривой плотности нормального распределения $\mathcal{N}(19.88, 4.92)$}
\label{img:histogram_fitted}
\end{figure}
Проанализируем эту гистограмму. Во-первых, на ней наглядно представлена близость выборочного распределения к нормальному с параметрами \normaldistr. Во-вторых, по этой гистограмме можно подтвердить или опровергнуть результаты, полученные на этапе вычисления описательных статистик.

Следует отметить согласованность полученных описательных статистик с полученной гистограммой. Во-первых, по коэффициенту асимметрии мы предположили о близости распределения к симметричному. Это подтверждается гистограммой: на ней можно заметить небольшую скошенность вправо, что также согласовывается со знаком коэффициента. Во-вторых, коэффициент эксцесса указывал на пологость пика распределения. Данное заключение подтверждается кривой плотности --- она имеет чуть более растянутую колоколообразную форму.

Другим часто используемым графическим способом проверки характера распределения данных является построение т.н. \textit{графиков квантилей} (\textit{Q-Q plots}, \textit{Quantile-Quantile plots}). На таких графиках изображаются квантили двух распределений --- эмпирического (т.е. построенного по анализируемым данным) и теоретически ожидаемого стандартного нормального распределения. При нормальном распределении проверяемой переменной точки на графике квантилей должны выстраиваться в прямую линию, исходящую под улом 45 градусов из левого нижнего угла графика. Графики квантилей особенно полезны при работе с небольшими по размеру совокупностями, для которых невозможно построить гистограммы, принимающие какую-либо выраженную форму.

В ходе данной работы была написана функция \textit{ggqqp}, с помощью которой построен рисунок \ref{img:qqnorm}.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/original/quantile.png}}
\caption{График квантилей для наблюдаемых температур}
\label{img:qqnorm}
\end{figure}
На этом графике можно визуально обнаружить аномальное положение наблюдаемых значений по отношению к нормальному распределению. В данном случае отклонения можно наблюдать на концах рассматриваемого промежутка. Остальные значения образуют отчетливую прямую. А значит, подтверждается предположение о нормальности выборочного распределения.

Далее следует проверить полученные результаты с помощью некоторых формальных тестов. Существует целый ряд статистических тестов, специально разработанных для проверки нормальности выборочного распределения. В общем виде проверяемую при помощи этих тестов нулевую гипотезу можно сформулиировать следующим образом: ``Анализируемая выборка происходит из генеральной совокупности, имеющей нормальное распределение''. Если получаемая при помощи того или иного теста вероятность ошибки $P$ оказывается меньше некоторого заранее принятого уровня значимости (например, $0.05$), нулевая гипотеза отклоняется.

В \textbf{R} реализованы практически все имеющиеся тесты на нормальность --- либо в виде стандарных функций, либо в виде функций, входящих в состав отдельных пакетов. Примером базовой функции является \textit{shapiro.test()}, при помощи которой можно выполнить широко используемый \textit{тест Шапиро-Уилка} \cite{Shapiro1972}. Из полученных в \textbf{R} результатов, статистика Шапиро-Уилка $ W = \test{original}{shapiro}{statistic} $. Вероятность ошибки $ p = \test{original}{shapiro}{p-value} > 0.05 $, а значит нулевая гипотеза не отвергается \cite{Kobzar2006}. Следовательно опровергнуть предположение на основе данного теста нельзя.

Попробуем опровегнуть наше предположение на основе проверки критерия $ \chi^2 $ Пирсона \cite{Gmurman2003}. Для этого воспользуемся пакетом \textit{nortest} и функцией \textit{pearson.test}. Из полученных в \textbf{R} результатов, статистика $\chi^2$ Пирсона $ P = \test{original}{pearson}{statistic}$. Вероятность ошибки $ p = \test{original}{pearson}{p-value} > 0.05 $, а значит нулевая гипотеза не отвергается. Следовательно опровергнуть предположение о нормальности на основе данного теста также нельзя. Проверим критерий: примем уровень значимости $\alpha = 0.05$, тогда из таблицы распределения $\chi^2$ найдём критическое значение критерия $P_{\textrm{кр}}(\alpha, k) = 43.8$. Отсюда следует, что

\begin{equation*}
	P < P_{\textrm{кр}}.
\end{equation*}

А значит, нулевую гипотезу при уровне значимости $\alpha = 0.05$ не отвергаем и подтверждаем сделанный вывод на основании вычисленной вероятности ошибки.

Воспользуемся для тех же целей критерием Колмогорова--Смирнова \cite{Mikulik2002}. Как в предыдущем случае воспользуемся представленной в пакете \textit{nortest} функцией \textit{ks.test}. Из полученных в \textbf{R} результатов, статистика Колмогорова-Смирнова $ D = \test{original}{ks}{statistic}$. Вероятность ошибки $ p = \test{original}{ks}{p-value} > 0.05 $, а значит нулевую гипотезу отвергнуть нельзя. Следовательно опровергнуть предположение о нормальности, как и предыдущих случаях, также нельзя. Проверим критерий: примем так же уровень значимости $\alpha = 0.05$, тогда критическое значение $D_{\textrm{кр}}(\alpha) = 1.358$. Следовательно,
\begin{equation*}
	D < D_{\textrm{кр}}(\alpha),
\end{equation*}
и подтверждаем сделанные ранее заключения: нельзя отвергнуть нулевую гипотезу о нормальности выборочного распределения.

На данном этапе по полученным ранее результатам возникли подозрения о выбросах в исходной выборке. Выявление таких аномальных значений важно, так как их наличие, как правило, сильно влияет на всю выборку, в частности, на коэффициент корреляции. Проверим наличие выбросов с помощью статистических критериев. Для этих целей воспользуемся критерием Граббса \cite{Grubbs1950Sample}. Данный основан на предположении о нормальности исходных данных. То есть, перед применением данного критерия необходимо убедиться, что данные могут быть в разумных пределах аппроксимированы нормальным распределением \cite{grubbs}. Поскольку ранее высказано предположение о нормальности, воспользуемся им для определения наличия выбросов.

Полученные результаты проверки критерия Граббса: статистика $ G = \test{original}{grubbs}{statistic} $, вероятность ошибки $ p\textrm{-value} = \test{original}{grubbs}{p-value} $ --- что однозначно говорит нам о том, что следует отклонить альтернативную гипотезу $H_{1}$ и принять гипотезу $H_{0}$. Другими словами, это говорит о том, что в исходной выборке нету выбросов. А значит выборка однородна. Таким образом, наши подозрения о выбросах не подтвердились проверкой критерия.

В соответствии с результатами проверки критериев и на основе построенных гистограммы и графика квантилей, можно сделать заключение о том, что распределение температуры воды озера Баторино в июле 1975--2009 годов является близким к нормальному закону распределения с параметрами \normaldistr. Что подтверждается коэффициентами асимметрии и эксцесса из таблицы \ref{table:dstats}, а также результатами, полученными мной при исследовании в пакете \textbf{STATISTICA}. Следует также отметить, что эквивалентные результаты были получены и для всей выборки.

% subsection basis (end)

\subsection{Корреляционный анализ} % (fold)
\label{sec:corr_analysis}

Исследуем теперь зависимость температуры воды от времени, построив диаграмму рассеяния и вычислив коэффициент корреляции соответствующих переменных.

Диаграммы рассеяния используются для визуального исследования зависимости между двумя переменными. Если переменные сильно связаны, то множество точек данных принимает определённую форму. С помощью таких диаграмм можно наглядно изучить знак коэффициента корреляции. Если точки на диаграмме расположены хаотически, то это говорит о независимости рассматриваемых переменных. Если с ростом переменной $t$ возрастает переменная $x$ то имеет место положительная корреляция. Если же с ростом переменной $t$ переменная $x$ убывает, то это указывает на отрицательную корреляцию.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/original/scatterplot.png}}
\caption{Диаграмма рассеяния}
\label{img:scatterplot}
\end{figure}

Из рисунка \ref{img:scatterplot} видно, что точки образуют своеобразное <<облако>>, ориентированное по диагонали вверх, то есть присутствует некая зависимость между рассмтриваемыми переменными. Также, данная диаграмма наглядно показывает силу этой зависимости: так как точки не образуют чёткой формы, а разбросаны относительно диагонали, то можно говорить о наличии умеренной корреляции. То есть, нельзя сказать, что зависимость сильная, но и нельзя сказать, что связь между переменными отсутствует.

Проверим полученные результаты подробнее. Из расчётов в \textbf{R}, коэффициент корреляции $ r_{xt} = \characteristic{original}{correlation} $. Этим подтверждаются наши выводы из диаграмм рассеяния и концентрации о положительной корреляции, поскольку полученный коэффициент корреляции является положительным и присутствует умеренная зависимость: $r_{xt} \approx 0.5$.

% \begin{equation*}
% 	T_{\textrm{набл}} = \frac{r_{xt} \sqrt{n - 2}}{\sqrt{1 - r_{xt}^2}} \approx 3.05885.
% \end{equation*}
% Рассмотрим уровень значимости $\alpha = 0.05$. Число степеней свободы $k = n - 2 = 36$. Тогда из таблицы критических точек распределения Стьюдента $t_\textrm{кр}(\alpha, k) \approx 2.03$. Следовательно,
% \begin{equation*}
% 	T_{\textrm{набл}} > t_\textrm{кр}(\alpha, k).
% \end{equation*}
% Значит нулевую гипотезу о равенстве нулю коэффициента корреляции генеральной совокупности следует отклонить \cite{Eliseeva1995}.

Оценим значимость полученного выборочного коэффициента корреляции с помощью возможностей пакета \textbf{R} и функции \textit{cor.test}. Представленная функция позволяет с помощью различных методов выполнять проверки значимости выборочного коэффициента корреляции. Воспользуемся проверкой теста методом Пирсона. Из результатов её выполнения статистика $ t = \test{original}{correlation}{statistic} $, количество степеней свободы $ df = \test{original}{correlation}{df} $ и вероятность ошибки $p = \test{original}{correlation}{p-value} < 0.05$, следовательно это говорит о том, что необходимо отвегнуть гипотезу $H_0: r = 0$.

Другими словами, выборочный коэффициент значимо отличается от нуля, т.е. температура воды и время при уровне значимости $\alpha = 0.05$ имеют зависимость.

Следует также отметить, что аналогичный анализ, проведённый в пакете STATISTICA, подобным образом выявил зависимость между температурой воды и временем.

Следовательно, в рассматриваемом случае можно говорить о присутствии значимой зависимости между температурой воды в озере Баторино и временем.

% subsection corr_analysis (end)

\subsection{Регрессионный анализ} % (fold)
\label{sec:regr_analysis}

Для введения последующих понятий анализа временных рядов воспользуемся \cite{Eddows1997}.

В отличие от анализа случайных выборок, анализ временных рядов основывается на предположении, что последовательные значения в файле данных наблюдаются через равные промежутки времени.

Большинство методов исследования временных рядов включает различные способы фильтрации шума, выделения сезонной и циклической составляющих, позволяющие увидеть регулярную составляющую более отчётливо.

Во временных рядах выделяют три составляющие:
\begin{enumerate}
	\item \textit{Тренд (тенденция развития) ($T$)} --- эволюционная составляющая, которая характеризует общее направление развития изучаемого явления и связанна с действием долговременных факторов развития.
	\item \textit{Циклические ($K$), сезонные ($S$) колебания} --- это составляющие, которые проявляются как отклонения от основной тенденции развития изучаемого явления, и связанны с действие краткосрочных, систематических факторов развития. Циклические колебания состоят в том, что значения признака в течение какого-то времени возрастают, достигают определённого максимума, затем убывают, достигают определённого минимума, вновь возрастают до прежних значений и т.д. Эту составляющую можно выявить только по данным за длительные промежутки времени, например, в 10, 15 или 20 лет. Сезонные колебания --- это колебания, периодически повторяющиеся в некоторое определённое время каждого года, месяца, недели, дня. Эти изменения отчётливо наблюдаются на графиках рядов динамики, содержащих данные за период не менее одного года.
	\item \textit{Нерегулярная случайная составляющая (ошибка) ($E$)}, являющаяся результатом действия второстепенных факторов развития.
\end{enumerate}
Первые два типа компонент представляют собой детерминированные составляющие. Случайная составляющая образована в результате суперпозиции некоторого числа внешних факторов.

По типу взаимосвязи вышеперечисленных составляющих ряда динамики можно построить следующие модели временных рядов ($X$):

\begin{itemize}
	\item Аддитивная модель: $X = T + K + S + E$;
	\item Мультипликативная модель: $X = T \times K \times S \times E$.
\end{itemize}
Аддитивной модели свойственно то, что характер циклических и сезонных колебаний остаётся постоянным.

В мультипликативной модели характер циклических и сезонных колебаний остаётся постоянным только по отношению к тренду (т.е. значения этих составляющих увеличиваются с возрастанием значений тренда).

По причине того, что в данном случае мы рассматриваем один месяц в году на протяжении длительного периода, будем считать, что в нашем временном ряде циклическая и сезонная составляющие отсутствуют. Построим график временного ряда.

\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/original/time-series.png}}
\caption{График временного ряда с линией регрессии}
\label{img:ts_regr}
\end{figure}

На полученном графике можно заметить явно выраженный линейный рост значений со временем --- он проиллюстрирован на графике прямой. Эта составляющая нашего временного ряда --- тренд. Из этого следует, что уравнение тренда имеет вид:
\begin{equation*}
	x(t) = at + b.
\end{equation*}

Продолжая рассуждение, как наблюдение из графика, можно отметить, что не происходит увеличения амплитуды колебаний с течением времени. А значит, данная модель является аддитивной. Из всего вышесказанного можно заключить, что модель исходного временного ряда имеет вид:
\begin{equation*}
	X = T + E.
\end{equation*}

В \textbf{R} реализованы функции, позволяющие подгонять линейные модели к исследуемым данным \cite{Shumway2006Time}. Одной из таких функций является \textit{lm(Fitting Linear Model)} \cite[c.178]{Kabacoff2009R}. Она позволяет получить коэффициенты линии регрессии(тренд), остатки после удаления тренда. Коэффицинты, полученные с помощью данной функции представлены в \eqref{eq:regr_coeff}.
\begin{equation}
\label{eq:regr_coeff}
	a = 0.1014, \quad b = 18.0521.
\end{equation}
Следует отметить, что в пакете \textbf{STATISTICA} похожая процедура была проведена для всей выборки с помощью инструмента \textit{Trend Subtract}, результаты которой согласуется с полученными в \textbf{R} коэффициентами.

Таким образом получена линейная модель, описывающая тенденцию развития:
\begin{equation}
\label{eq:regr}
	x(t) = at + b = 0.1014t + 18.0521
\end{equation}

На основе полученной линейной модели \eqref{eq:regr}, построим ряд остатков(приложение \ref{c:app_results}, таблица \ref{table:residuals}), удалив тренд из исходного ряда. Полученный ряд графически представлен на рисунке \ref{img:ts_detrended} в приложении \ref{c:graphs}.

Проведём анализ полученной регрессионной модели. Для этого проверим значимость полученных коэффициентов регрессии и оценим адекватность регрессионной модели.
% TODO: Устаревшие вычисления // Реализовать в R
Рассчитаем вспомогательные величины, воспользовавшись \cite{Eddows1997}. Дисперсия отклонения
\begin{equation*}
	\sigma_{\varepsilon}^2 \approx 3.823,
\end{equation*}
стандартные случайные погрешности параметров $a, b$:
\begin{equation*}
	\sigma_{a} \approx 0.029, \quad \sigma_{b} \approx 0.356.
\end{equation*}

Воспользуемся критерием значимости коэффициентов линейной регрессии \cite{Eliseeva1995}. Примем уровень значимости $\alpha = 0.05$, тогда
\begin{equation*}
	T_{a} = 38.2, \quad T_{b} = 50.5.
\end{equation*}

Число степеней свободы $k = 36$, $t_{\textrm{кр}}(k, \alpha) = 2.028$.

\begin{itemize}
	\item $\vert T_{a} \vert > t_{\textrm{кр}}$ $\Rightarrow$ коэффициент $a$ значим.
	\item $\vert T_{b} \vert > t_{\textrm{кр}}$ $\Rightarrow$ коэффициент $b$ значим.
\end{itemize}
Следовательно, при уровне значимости $\alpha = 0.05$, коэффициенты линейной регрессии являются значимыми.

Оценим адекватность полученной регрессионной модели. Дисперсия модели:
\begin{equation*}
	\overline{\sigma^2} \approx 1.44.
\end{equation*}

Остаточная дисперсия:
\begin{equation*}
	\overline{D} \approx 3.7.
\end{equation*}

Воспользуемся F-критерием Фишера. Пусть уровень значимости $\alpha = 0.05$,
\begin{equation*}
	F_{\textrm{крит}} \approx 14.01,
\end{equation*}
при степенях свободы $v_1 = 1, v_2 = 36, F_{\textrm{табл}}(v_1, v_2, \alpha) = 4.11$.

\begin{equation*}
	F_{\textrm{крит}} > F_{\textrm{табл}}.
\end{equation*}
Следовательно, при уровне значимости $\alpha = 0.05$, регрессионная модель является адекватной.

Рассчитаем коэффициент детерминации:
\begin{equation*}
	\eta_{x(t)}^2 \approx 0.275.
\end{equation*}

Проверим отклонение от линейности: $\eta_{x(t)}^2 - r_{xt}^{2} \approx 0.0044 \le 0.1$. Следовательно отклонение от линейности незначительно. Но при этом коэффициент детерминации оказался не достаточно высоким($<0.7$), это говорит о том, что построенная регрессионная модель не описывает в достаточной мере поведение временного ряда. Это, в свою очередь, может значить, что изменение температуры зависит не только от времени, но ещё и от каких-то других, неучтённых, факторов.

Тем не менее, попробуем построить прогноз по полученной модели. Вычисленые прогнозные значения на 2010-2012 годы для сравнения отображены на таблице \ref{table:prediction_trend}:
\input{../out/residual/prediction-trend.tex}

Имеющееся отклонение прогнозов от реальных данных ещё раз подтверждает, что построенная модель временного ряда обладает невысокой точностью.

% /TODO: Устаревшие вычисления // Реализовать в R
% subsection regr_analysis (end)

\subsection{Анализ остатков} % (fold)
\label{sub:analysis_residuals}

% TODO: "временной ряд остатков" нужно как-то заменить и подвести к epsilon
Проанализируем временной ряд остатков. Для этого проверим свойства, которым должна удовлетворять нерегулярная составляющая $\varepsilon$:
\begin{enumerate}
	\item $E(\varepsilon) = 0$.
	\item Дисперсия $\varepsilon$ постоянна для всех значений.
	\item Остатки независимы и нормально распределены.
\end{enumerate}
Вычислим описательные статистики для остатков. Полученные результаты проследим по таблице \ref{table:residuals_dstats}.
\input{../out/residual/dstats.tex}

Как видно из таблицы \ref{table:residuals_dstats}, среднее значение равно нулю. При этом коэффициенты асимметрии($ A_S = \descriptive{residual}{skew} $) и эксцесса($ K = \descriptive{residual}{kurtosis} $) указывают на большее отклонение распределения остатков от нормального закона.

Построим гистограмму и график квантилей для проверки последних заключений. Построенная гистограмма (приложение \ref{c:graphs}, рисунок \ref{img:resid_hist}) наглядно демонстрирует полученные в таблице \ref{table:residuals_dstats} коэффициенты асимметрии и эксцесса.

Для проверки нормальности построим график квантилей.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/residual/quantile.png}}
\caption{График квантилей для остатков}
\label{img:resid_qqnorm}
\end{figure}
На рисунке \ref{img:resid_qqnorm} можно заметить, что присутствуют отклонения относительно нормального распределения. Наиболее явный из них --- нижний хвост. Остальные --- небольшие скачки по ходу линии нормального распределения. Проверим с помощью критерия Шапиро-Уилка, можно ли считать полученные остатки нормально распределёнными. Из полученных в \textbf{R} результатов, статистика Шапиро--Уилка $ W = \test{residual}{shapiro}{statistic} $. Вероятность ошибки $ p = \test{residual}{shapiro}{p-value} > 0.05 $, а значит нулевая гипотеза не отвергается. Следовательно опровергнуть предположение о нормальности на основе данного теста нельзя.

Проверим критерий $ \chi^2 $ Пирсона. Из полученных в \textbf{R} результатов, статистика $\chi^2$ Пирсона $ P = \test{residual}{pearson}{statistic}$. Вероятность ошибки $ p = \test{residual}{pearson}{p-value} > 0.05 $, а значит нулевая гипотеза не отвергается.% TODO: Устаревшие вычисления // Реализовать в R
Но при этом, это значение очень близко к $ 0.05 $. Проверим критерий: примем уровень значимости $\alpha = 0.05$, тогда из таблицы распределения $\chi^2$ найдём критическое значение критерия $ \chi_{\textrm{кр}}^2(\alpha, k) \approx 43.8 $. Отсюда следует, что
\begin{equation*}
	\chi_{\textrm{набл}}^2 < \chi_{\textrm{кр}}^2,
\end{equation*}
где $ \chi_{\textrm{набл}}^2 = P = \test{residual}{pearson}{statistic} $. А значит, гипотезу о нормальности не отклоняем.
% /TODO: Устаревшие вычисления // Реализовать в R

Построим график автокорреляционной функции для определения наличия взаимосвязей в ряде остатков (рисунок \ref{img:resid_acf}). На графике пунктирные линии разграничивают значимые и не значимые корреляции: значения, выходящие за линии, являются значимыми \cite[с.376]{Teetor2011RCook}.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/residual/acf.png}}
\caption{График автокорреляционной функции}
\label{img:resid_acf}
\end{figure}
На представленном графике автокорреляционной функции можно заметить на лаге $15$ значение, выходящее за интервал, обозначенный пунктирными линиями. Проверим значимость автокорреляций с помощью теста Льюнга-Бокса \cite[с.377-378]{Teetor2011RCook}. Данный тест проверяет наличие автокорреляций в исследуемом ряде. Используя возможности пакета \textbf{R} получили значения: статистика Льюнга--Бокса $ X^2 = \test{residual}{ljung-box}{statistic} $ и вероятность ошибки $ p = \test{residual}{ljung-box}{p-value} > 0.05$ --- это говорит о том, что тест не выявил значимых автокорреляций.

На рисунке \ref{img:resid_acf} также можно заметить некоторое затухание всвязи с увеличением лага. На основе этого можно сделать предположение о стационарности. Для проверки этого предположения воспользуемся расширенным тестом Дики--Фуллера(ADF) \cite{Dickey1979Distribution}. Из результатов проверки теста, статистика Дики-Фуллера $ DF = \test{residual}{stationarity}{statistic} $, вероятность ошибки $ p = \test{residual}{stationarity}{p-value} < 0.05 $. Следовательно, необходимо принять альтернативную гипотезу о стационарности.
% TODO: надо подумать. p-value для обрезанного ряда оказался не вери-гуд

Полученная модель оказалась неоднозначной. С одной стороны, полученное значение коэффициента детерминации показало недостаточную точность полученной модели и не удалось достоверно показать нормальность ряда остатков. С другой стороны, была показана стационарность и отсутствие автокорреляции. Поэтому возникает необходимость строить модель другими методами.

% subsubsection analysis_residuals (end)

% section determenistic (end)

\section{Геостатистический подход} % (fold)
\label{sec:geostatistic}

\subsection{Вариограммный анализ. Кригинг.} % (fold)
\label{sec:_variogram}

В данной части работы для более объективного оценивания полученных прогнозов возьмем в качестве исследуемой выборки первые $32$ значения исходных данных.

Традиционные детерминированные методы, широко используемые в задачах прогнозирования, в большинстве случаев на практике не позволяют в полной мере решить ту или иную задачу. В наиболее благоприятных вариантах исследований они позволяют оценивать значения в точках, в которых измерения не проводились и определять значения на плотной сетке (в близких к измерениям точках). Следует также отметить, что данные измерений, как правило, дискретны и неоднородно распределены. В свою очередь, анализ этих данных и его результаты в значительной мере зависят как от качества так и от количества исходных данных. И именно такие выводы были сделаны в результате проделанной в предыдущих частях данной работы. Отсюда следует, что необходимо использовать другие современные методы, позволяющие сделать более точные модели и выводы.

Для поставленной задачи в современных исследованиях хороших результатов позволяет добиться методы геостатистики, что подтверждается работами \cite{GeoStCompar1987, GeoStCompar1998}. Современная геостатистика --- это широкий спектр статистических моделей и инструментов для анализа, обработки и представления пространственно-распределенной информации.

В рамках геостатистики, для получения наилучшей в статистическом смысле пространственной оценки используются модели из семейства кригинга (\textit{kriging}) --- наилучшего линейного несмещенного оценивателя (\textit{Best Linear Unbiased Estimator --- BLUE}). Кригинг является ``наилучшим'' оценивателем в статистическом смысле --- его оценка обладает минимальной дисперсией. Важным свойством кригинга является точное воспроизведение значений измерений в имеющихся точках (интерполяционные свойства). В отличие от многочисленных детерминированных методов оценка кригинга сопровождается оценкой ошибки интеполяции в каждой точке. Полученная ошибка позволяет охарактеризовать неопределенность интерполяционноий оценки данных при помощи доверительных интервалов.

В отличие от детерминированных методов, геостатистические оценки опираются на информацию о внутренней структуре данных, зависят от самих данных, т. е. являются адаптивными.

В различных геофизических явлениях выделяют свойство пространственной непрерывности: чем ближе две точки, тем ближе значение. Для оценки данного свойства построим диаграмму взаимного разброса пар точек (\textit{h-scatterplot}), разделённых расстоянием $ h $. Эта диаграмма позволяет увидеть пространственную непрерывность и проверить наличие корреляции в данных как качественно, так и количественно \cite{saveliev2012}.
\begin{figure}[H]
	\center{\includegraphics[width=1\linewidth]{../figures/residual/hscat.pdf}}
\caption{Диаграмма взаимного разброса}
\label{img:hscat}
\end{figure}
Построенная диаграмма (рисунок \ref{img:hscat}) отображает поведение данных с увеличением лага. Следует отметить, что в классическом случае присутствия зависимости, поведение должно было быть следующим: на начальных графиках сильная концентрация, и с увеличением лага эта концетрация уменьшается. В нашем случае такого не наблюдается. Напротив, на всех лагах присутствует слабая зависимость. Что, вообще говоря, вполне обосновано спецификой исследуемых данных: рассматривается температура воды за один определённых месяц в течение нескольких лет. Ко всему прочему, это подтверждается результатами проведённого ранее анализа остатков.

Центральная идея геостатистики состоит в использовании знаний о пространственной корреляции экспериментальных данных для построения пространственных оценок и интерполяций. Вариограмма --- ключевой инструмент для оценки степени пространственной корреляции, имеющейся в данных, и для ее моделирования. Модель вариограммы является функцией, определяющей зависимость изменения исследуемой величины в пространстве от расстояния. Следовательно, интерполяционная модель, основанная на такой корреляционной функции, будет отражать реальные явления, которые лежат в основе данных измерений. Всевозможные пары точек могут быть рассортированы по классам в соответствии с разностью их координат $ h = x_i - x_j $, называемой \textit{лагом}. Для близких точек разность значениеq функции в них обычно меньше и растет с увеличением расстояния между точками. Вычислив среднее значение квадратов разностей для каждого значения лага $h$ (для каждого собранного класса пар измерений), можно получить дискретную функцию, называемую \textit{экспериментальной вариограммой}. Вариограмма обычно характеризуется тремя значениями: эффект самородков(\textit{nugget}), ранг(\textit{range}) и порог(sill). Эффект самородков характеризуется разрывом вариограммы около нуля. Порог характеризует предельное значение вариограммы, на некотором расстоянии, называемом рангом, за которым последующие значения вариограммы становятся некоррелированными.

Также при построении вариограммы следует учитывать параметр максимального расстояния, для которого вычисляется вариограмма. Первоначальным параметром было выбрано следующее значение: $ 2n / 3 = 21 $ \cite{cressie2011statistics}.

Построим экспериментальную вариограмму с помощью пакета \textit{gstat} и функции \textit{variogram}. С помощью этой функции можно построить экспериментальную вариограмму, основанную на классической оценки вариограммы и робастной оценки Кресси \cite{cressie2011statistics}. Построим экспериментальную вариограмму с помощью классической оценки.

Построенная вариограмма отображена на рисунке \ref{img:classical_emp} в приложении \ref{c:graphs}. На представленном рисунке можно заметить, что на промежутке $[0;1]$ не происходит роста значений вариограммы. Наоборот, наблюдается разрыв: первое значение находится значительно выше $0$. При этом вариограмма не сильно выходит за пределы дисперсии переменной, которая равна $4.07$. Более того, первые значения уже достигло порога. Что говорит о том, что вариограмма на первых значениях выходит на предельное значение, и последующие значения некоррелированы. Это, на самом деле, согласуется с нашими исходными данными, так как при анализе остатков было выявлено отстутсвие автокорреляций, и спецификой самих данных: наблюдение за каждый год, вообще говоря, не зависит от предшедствующего.

На основе этого делаем вывод о наличии эффекта самородков и делаем первоначальное предположение о равенстве порога $3.9$.

На основе экспериментальной вариограммы построим модель вариограммы для дальнейшего использования на этапе кригинга. Моделью вариограммы может служить не каждая функция, а только та, для которой выполнено условие положительной определенности. Положительная определенность модели вариограммы гарантирует, что уравнения кригинга, построенные с использованием данной модели, имеют единственное устойчивое решение. Поэтому при моделировании используются только те функции, для которых положительная определенность установлена, а также их взвешенные линейные комбинации с неотрицательными весами, которые тоже будут являться положительно определенными. Модель вариограммы строится как линейная комбинация подходящих базисных моделей \cite{saveliev2012}.

Для построения моделей вариограммы существует два подхода: вручную, т.е. визуально с ручным подбором параметров, и автоматическим подбором параметров с помощью специальных методов. И на практике построение модели вариограммы представляет собой итеративный процесс, на каждом шаге которого следует наилучшим образом подобрать параметры очередного модельного приближения. В различной литературе рекомендуется строить моделей вручную, так как исследователь лучше знает специфику данных, чем различные методы оценивания. Попробуем построить модель вариограммы визуально.

Ранее было отмечено присутствие эффекта самородков. Другой, часто встречающейся моделью, является сферическая:
\begin{equation}
	\gamma(\vert h \vert) = c Sph_a(\vert h \vert) = \left\{
 \begin{array}{l l}
   c(1.5 \vert h \vert / a - 0.5(\vert h \vert / a)^3) &, \vert h \vert \le a, \\
   \\
   c &,	 \vert h \vert > a.
 \end{array} \right.
\end{equation}

Возьмём эту модель в качестве базовой с помощью функции \textit{vgm}, в качестве начального параметра возьмём порог, указанный ранее: $3.9$. Далее воспользуемся функцией \textit{fit.variogram} для подбора более точных значений указанной модели. Таким образом окончательная модель:
\input{../out/variogram/manual-model.tex}
И график полученной модели на рисунке \ref{img:var-models} (пунктиром). На графике можно проследить все указанные ранее особенности: эффект самородков и порог.
\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/variogram/models-comparison.png}}
\caption{Классические модели вариограммы}
\label{img:var-models}
\end{figure}

Задача геостатистики --- оценить значения изучаемой пространственной переменной в произвольных точках области исследования на основе анализа ее значений, измеренных в ограниченном числе выборочных точек. По построенной модели вычислим оценки при помощи ординарного кригинга, реализованного функцией \textit{krige}. Вычисленные значения отображены в таблице \ref{table:prediction-manual} в приложении \ref{c:app_results}. Оценку отклонения от истинных значений выразим с помощью среднеквадратической ошибки \textit{(MSE)}. В данном случае $ MSE = \characteristic{variogram}{manual-mse} $. Полученные значения оказались идентичными значению тренда, следовательно прогноз почти не изменился. Это говорит о том, что построенная модель не смогла уловить поведение исходных данных. По этой причине был использован второй вариант построения модели --- c автоматическим подбором параметров.

Для построения модели вариограммы была реализована возможность автоматического подбора модели на основе функции \textit{fit.variogram}. Суть этого подхода заключается в следующем: при заданных начальных условиях (эффект самородков, ранг, порог), для всех возможных базисных моделей подгонялись их параметры, для этих моделей вычислялись сумма квадратов ошибок, и на основе этого показателя выбиралась наиболее эффективная модель. Код программы представлен в листинге \ref{lst:main}.

На рисунке \ref{img:var-models} сплошной линией и в приложении \ref{c:graphs} на рисунке \ref{img:manual-mod} показан результат выполнения представленной ранее функции. Таким образом, наилучшей моделью вариограммы, построенной по классической оценке, стала линейная комбинация двух: эффект самородков с параметром $ \characteristic{variogram}{classical-nug} $ и модель с эффектом дыр (\textit{Hole}) с параметрами: порог --- $ \characteristic{variogram}{classical-psill} $, ранг --- $ \characteristic{variogram}{classical-range} $ изображенная в приложении \ref{c:graphs} на рисунке \ref{img:classical-mod}.

Методом простого кригинга в этом случае были построены прогнозные значения, отображенные в таблице \ref{table:prediction-classical}.
\input{../out/variogram/prediction-classical.tex}
Полученные значения отличаются от предыдущих, в них появилось некоторое поведение. Но в данном случае $ MSE = \characteristic{variogram}{classical-mse} $, что хуже предыдущего значения, а значит, прогноз ухудшился.
Попробуем улучшить результат с помощью робастной оценки Кресси.

Модель вариограммы, представленная на рисунке \ref{img:robust-mod} в приложении \ref{c:graphs}, является также линейной комбинацией двух базисных моделей: эффекта самородков с параметром $ \characteristic{variogram}{robust-nug} $ и волновая модель с параметрами: $ \characteristic{variogram}{robust-psill} $, $ \characteristic{variogram}{robust-range} $. Заметим, что эмпирическая вариограмма, построенная по робастной оценке, отличается от соотвествующей вариограмм, построенных по классической оценке. Появилось заметное поведение вариограммы, в отличие от предыдущей, где значения концентрировались около дисперсии выборки.

Результаты применения кригинга показали прогнозные значения, указанные в \ref{table:prediction-robust}.
\input{../out/variogram/prediction-robust.tex}
Среднеквадратическая ошибка $ MSE = \characteristic{variogram}{robust-mse} $, таким образом это значение близко к значению, полученному вручную. Таким образом, использование робастной оценки улучшило результат применения кригинга.

\begin{figure}[ht]
	\center{\includegraphics[width=1\linewidth]{../figures/variogram/parameter-comparison.png}}
\caption{Зависимость ошибки от максимального расстояния}
\label{img:check-dep}
\end{figure}

Исследуем теперь поведение прогнозных значений, полученных с помощью кригинга, при различных параметрах максимального расстояния вариограммы. В качестве оценки качества полученного прогноза возьмем среднеквадратическую ошибку. Чем меньше ошибка --- тем лучше прогноз. Для этих целей реализована функция \textit{ComparePredictionParameters}. Результат её работы на рисунке \ref{img:check-dep}. На этом графике отчетливо видно, что робастная оценка (пунктир-точка), в отличие от классической (пунктир) и модели, построенной вручную (сплошная), в большинстве случаев даёт более точные прогнозы. И наилучший при максимальном расстоянии равным $6$. С этим параметром, наилучший прогноз составляют значения кригинга из \ref{table:prediction-robust-best}.
\input{../out/variogram/prediction-robust-best.tex}
Среднеквадратическая ошибка оказалась равной $ MSE = \characteristic{variogram}{robust-best-mse} $. Что действительно является лучшим из полученных показателем.

Сравнительный анализ полученного прогноза представлен на графике \ref{img:cross-prediction-best} в приложении \ref{c:graphs}.

Таким образом в результате вариограммного анализа были исследованы различные модели вариограмм, оценки, проведены два подхода по вычислению. В результате кригинга построена наилучшая модель прогнозных значений. Которая в свою очередь имеет погрешность в пределах стандартного отклонения. Следовательно данная модель является хорошим вариантом для построения прогнозных значений.

% subsection _variogram (end)

% section geostatistic (end)