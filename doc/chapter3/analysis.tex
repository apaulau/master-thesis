% (PARTIAL)
\newpage

\chapter{Обработка реального временного ряда с помощью R}

\section{Вычисление основных описательных статистик} % (fold)
\label{sec:dstats}

В качестве исходных данных примем выборку из полученной от учебно-научного центра базы данных, путём отбора наблюдений в июле месяце за период с 1975 по 2012 год. Выборка представлена в приложении \ref{c:source_data} в таблице \ref{table:source}. Графически исходные данные представлены на рисунке \ref{img:input}.

\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/01_src.png}}
\caption{График исходных данных.}
\label{img:input}
\end{figure}

Следует отметить, что для непосредственного исследования были использованы наблюдения с 1975 по 2009 год. Наблюдения за 2010-2012 годы были намеренно исключены из исследования в целях дальнейшего оценивания результатов анализа и прогнозирования. Заметим, что работа, представленная в параграфах \ref{sec:dstats}--\ref{sec:regr_analysis}, была также проделана и для всей выборки. Так как поведение целой выборки сохранилось в уменьшенной, то, без потери общности, будем считать её исходной.

Начнём исследование временного ряда с вычисления описательных статистик. \textbf{R} предоставляет в пакете \textit{base} такие функции как: \textit{var} --- дисперсия, \textit{mean} --- среднее, \textit{sd} --- стандартное отклонение, \textit{median} --- медиана, \textit{quantile} --- квантили, \textit{range} --- размах, \textit{min, max}. Также, в различных пакетах можно найти другие интерисующие функции, как статистические, так и математические. Но в целях удобства, компактности и контроля за функциональностью мной был написан модуль \textit{dstats}. Данный модуль позволяет вычислять все необходимые в данной работе описательные статистики. 
	
Для получения всех описательных статистик воспользуемся представленным в приложении \ref{c:listings} листинге \ref{lst:dstats} модулем. Полученные результаты отображены в таблице \ref{table:dstats}.

\input{../out/data_dstats.tex}

Рассмотрим подробнее некоторые полученные статистики.

Как видно из таблицы, \textit{средняя} температура в июле месяце за период с 1975 по 2009 составляет приблизительно 20ºС. При этом \textit{размах} температур равен 8.2ºC. \textit{Дисперсия} в данном случае равна $4.91$.

\textit{Стандартное отклонение} оказалось равным приблизительно $2.21$. Полученное значение не велико, а значит можно сказать, что среднее значение хорошо описывает выборку. И что в среднем, температура воды озера Баторино отличается от полученной ранее \textit{средней} температуры на 2.2ºC.

\textit{Коэффициент вариации} в нашем случае равен $24.7\%$. Из этого следует, что выборку можно счиать однородной, так как полученное значение является меньшим 33\%.

\textit{Стандартная ошибка среднего значения} равна $0.37$.

\textit{Коэффициент асимметрии} --- мера симметричности распределения. Полученное значение: $0.18$. Данное значение говорит о незначительной правосторонней асимметрии распределения. То есть о том, что выборочное распределение можно считать близким к симметричному.

\textit{Cтандартная ошибка асимметрии} равна $0.40$.

\textit{Коэффициент эксцесса} в рассматриваемом случае равен $-0.85$. Так как коэффициент эксцесса нормального распределения равен $0$, то в данном случае можно говорить о пологости пика распределения выборки по отношению к нормальному распределению. 

\textit{Стандартная ошибка коэффициента эксцесса} равна $0.77$. 

По данному ранее определению тестовых статистик для коэффициента асимметрии и эксцесса, проверим значимость полученных значений для генеральной совокупности. Для этого в модуле \textit{dstats} мной реализованы функции \textit{dstats.test.skew} и \textit{dstats.test.kurtosis}:

Полученная тестовая статистика для коэффициента асимметрии:
\begin{equation*}
	Z_{A_S} = \frac{A_S}{SES} = 0.4648153
\end{equation*}
Данное значение попадает под случай $\vert Z_{A_S} \vert \le 2$, а значит, выборочный коэффициент асимметрии не является значимым. Из чего, в свою очередь, следует, что по нему нельзя судить о коэффициенте асимметрии генеральной совокупности.

Полученная тестовая статистика для коэффициента эксцесса:
\begin{equation*}
	Z_K = \frac{K}{SEK} = -1.015476.
\end{equation*}
Данное значение попадает под случай $\vert Z_K \vert \le 2$, а значит, в данном случае выборочный коэффициент эксцесса не является значимым и нельзя ничего сказать о коэффициенте эксцесса генеральной совокупности.

Из полученных результатов следует отметить, что коэффициенты асимметрии и эксцесса, указывают на близость выборочного распределения к нормальному закону. Но при этом, из-за недостаточного объёма выборки, по этим коэффициентам нельзя судить о соответствующих коэффициентах генеральной совокупности.

% section dstats (end)

\section{Исследование статистических данных} % (fold)
\label{sec:analysis}

В \textbf{R} можно найти различные пакеты, позволяющие строить разнообразные гистограммы, диаграммы рассеяния, вероятностные графики, линейные графики, диаграммы диапазонов, размахов, круговые диаграммы, столбчатые диаграммы, последовательные графики и т.д., позволяющие увидеть специфику данных.

В пакет \textit{base} для визуализации входят такие функции как:
\begin{itemize}
	\item \textit{plot}: общая функция для построения графиков $y(x)$;
	\item \textit{barplot}: столбцовые диаграммы;
	\item \textit{boxplot}: график ``ящик-с-усами'';
	\item \textit{hist}: гистограммы;
	\item \textit{pie}: круговые диаграммы;
	\item \textit{dotchart}: точечные графики;
	\item \textit{image, heatmap, contour, persp}: функции для генерации трёхмерных графиков;
	\item \textit{qqnorm, qqline, qqplot}: графики квантилей;
	\item \textit{pairs, coplot}: отображают на графиках несколько выборок.
\end{itemize}

С помощью функции пакета \textit{ggplot2} построим гистограмму для отображения вариационного ряда исходных данных. Гистограммы позволяют увидеть, как распределены значения переменных по интервалам группировки, то есть как часто переменные принимают значения из различных интервалов. А также, что бывает более важным, повзоляет сделать предположение о разновидности распределения. Для вычисления интервалов разбиения воспользуемся \textit{формулой Стерджеса}. Из \cite{Sturges1926Choice} количество интервалов разбиения рассчитывается по формуле:
\begin{equation}
\label{eq:sturges}
	k = \lceil log_{2}n \rceil + 1 = \lceil log_{2}38 \rceil + 1 = 7.
\end{equation}

Так как по гистограмме можно визуально предположить близость выборочного распределения к нормальному распределению, нанесём на график кривую плотности нормального распределения. Построенная гистограмма отображена на рисунке \ref{img:histogram_fitted}.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/03_hist-dnorm.png}}
\caption{Гистограмма наблюдаемых температур с кривой плотности нормального распределения}
\label{img:histogram_fitted}
\end{figure}
Проанализируем эту гистограмму. Во-первых, на ней наглядно представлена близость выборочного распределения к нормальному с параметрами $\mathcal{N}(19.88, 4.91)$. Во-вторых, по этой гистограмме можно подтвердить или опровергнуть результаты, полученные на этапе вычисления описательных статистик в параграфе \ref{sec:dstats}.

Следует отметить согласованность полученных описательных статистик с полученной гистограммой. Во-первых, по коэффициенту асимметрии мы предположили о близости распределения к симметричному. Это подтверждается гистограммой: на ней можно заметить небольшую скошенность вправо, что также согласовывается со знаком коэффициента. Во-вторых, коэффициент эксцесса указывал на пологость пика распределения. Данное заключение подтверждается кривой плотности --- она имеет чуть более растянутую колоколообразную форму.

Другим часто используемым графическим способом проверки характера распределения данных является построение т.н. \textit{графиков квантилей} (\textit{Q-Q plots}, \textit{Quantile-Quantile plots}). На таких графиках изображаются квантили двух распределений --- эмпирического (т.е. построенного по анализируемым данным) и теоретически ожидаемого стандартного нормального распределения. При нормальном распределении проверяемой переменной точки на графике квантилей должны выстраиваться в прямую линию, исходящую под улом 45 градусов из левого нижнего угла графика. Графики квантилей особенно полезны при работе с небольшими по размеру совокупностями, для которых невозможно построить гистограммы, принимающие какую-либо выраженную форму.

В \textbf{R} для построения графиков квантилей можно использовать базовую функцию \textit{qqnorm}. В процессе данной работы была написана функция \textit{qqp}, с помощью которой и построен рисунок \ref{img:qqnorm}.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/04_qq.png}}
\caption{График квантилей для наблюдаемых температур}
\label{img:qqnorm}
\end{figure}
На этом графике можно визуально обнаружить аномальное положение наблюдаемых значений по отношению к нормальному распределению. В данном случае отклонения можно наблюдать на концах рассматриваемого промежутка. Остальные значения образуют отчетливую прямую. А значит, подтверждается предположение о нормальности выборочного распределения.

Далее следует проверить полученные результаты с помощью некоторых формальных тестов. Существует целый ряд статистических тестов, специально разработанных для проверки нормальности выборочного распределения. В общем виде проверяемую при помощи этих тестов нулевую гипотезу можно сформулиировать следующим образом: ``Анализируемая выборка происходит из генеральной совокупности, имеющей нормальное распределение''. Если получаемая при помощи того или иного теста вероятность ошибки $P$ оказывается меньше некоторого заранее принятого уровня значимости (например, $0.05$), нулевая гипотеза отклоняется.

В \textbf{R} реализованы практически все имеющиеся тесты на нормальность --- либо в виде стандарных функций, либо в виде функций, входящих в состав отдельных пакетов. Примером базовой функции является \textit{shapiro.test()}, при помощи которой можно выполнить широко используемый \textit{тест Шапиро-Уилка}:
\input{../out/shapiro.tex}
В полученных результатах $W$ --- статистика Шапиро-Уилка. Вероятность ошибки $p = 0.5685 > 0.05$, а значит нулевая гипотеза не отвергается. Следовательно опровергнуть предположение на основе данного теста нельзя.

Попробуем опровегнуть наше предположение на основе проверки критерия $\chi^2$ Пирсона. Для этого воспользуемся пакетом \textit{nortest} и функцией \textit{pearson.test}:
\input{../out/pearson.tex}
В полученных результатах $P$ --- статистика $\chi^2$ Пирсона. Вероятность ошибки $p = 0.8335 > 0.05$, а значит нулевая гипотеза не отвергается. Следовательно опровергнуть предположение о нормальности на основе данного теста также нельзя. Проверим критерий: примем уровень значимости $\alpha = 0.05$, тогда из таблицы распределения $\chi^2$ найдём критическое значение критерия $P_{\textrm{кр}}(\alpha, k) = 43.8$. Отсюда следует, что

\begin{equation*}
	P < P_{\textrm{кр}}.
\end{equation*}

А значит, нулевую гипотезу при уровне значимости $\alpha = 0.05$ не отвергаем и подтверждаем сделанный вывод на основании вычисленной вероятности ошибки. 

Воспользуемся для тех же целей критерием Колмогорова--Смирнова. Как в предыдущем случае воспользуемся представленной в пакете \textit{nortest} функцией \textit{ks.test}:
\input{../out/ks.tex}
Вероятность ошибки $p > 0.05$, а значит нулевую гипотезу отвергнуть нельзя. Следовательно опровергнуть предположение о нормальности, как и предыдущих случаях, также нельзя. Проверим критерий: примем так же уровень значимости $\alpha = 0.05$, тогда критическое значение $D_{\textrm{кр}}(\alpha) = 1.358$. Следовательно,
\begin{equation*}
	D < D_{\textrm{кр}}(\alpha),
\end{equation*}
и подтверждаем сделанные ранее заключения: нельзя отвергнуть нулевую гипотезу о нормальности выборочного распределения.

Воспользуемся ещё одним из графических инструментов анализа данных --- Bag Plot (диаграмма концентрации). 
Диаграмма концентрации является двумерным обобщением широко известного графика <<ящик-с-усами>>. Данный инструмент применяется для поиска нетипичных наблюдений по сочетанию пары количественных признаков (в нашем случае это дата и температура). Основными компонентами данной диаграммы являются <<мешок>>, который содержит $50\%$ значений выборки, граница, которая отделяет внутренние точки от выбросов, и контур, показывающий точки снаружи <<мешка>>, но внутри границы. Аналогично диаграмме размаха, диаграмма концентрации визуализирует некоторые характеристики выборочных данных: положение выборки (расположением медианы), распространение (размер <<мешка>>), корреляция (ориентация <<мешка>>), асимметрия (форма <<мешка>> и контура), хвосты (точки на границе контура и выбросы) \cite{Rousseeuw1999Bagplot}.

Результат построения диаграммы проиллюстрирован на рисунке \ref{img:bagplot}.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/05_bagplot.pdf}}
\caption{Диаграмма концентрации}
\label{img:bagplot}
\end{figure}
В центре полученной диаграммы находится медиана, <<мешок>> обозначен темным оттенком, контур светлым, выбросы обозначены перекрестием. Следовательно, выбросы не обнаружены, но следует отметить, что несколько точек находятся на самой границе контура --- будем считать их подозрительными на выброс. По диаграмме также можно сказать о корреляции рассматриваемых переменных: <<мешок>> ориентирован вверх, что говорит о положительной корреляции. Также можно сделать заключения по асимметрии и проверить результаты, полученные на этапе вычисления описательных статистик. На диаграмме можно видеть, полученная фигура очень похожа на эллипс с центром, обозначенным медианой. Как следствие этого, можно судить о близости выборочного распределения с симметричным распределением, что подтверждает полученные ранее в анализе описательных статистик, представленных в таблице \ref{table:dstats}, результаты.

На данном этапе по результатам полученных на основе графиков \ref{img:qqnorm} и \ref{img:bagplot} возникли подозрения о выбросах в исходной выборке. Выявление таких аномальных значений важно, так как их наличие, как правило, сильно влияет на всю выборку, в частности, на коэффициент корреляции. Проверим наличие выбросов с помощью статистических критериев. Для этих целей воспользуемся критерием Граббса. Воспользуемся им для определения наличия выбросов в исходной выборке. 

Полученные результаты проверки критерия Граббса:
\input{../out/grubbs.tex}
Данный результат ($p\textrm{-value} = 1$) однозначно говорит нам о том, что следует отклонить альтернативную гипотезу $H_{1}$ и принять гипотезу $H_{0}$. Другими словами, это говорит о том, что в исходной выборке нету выбросов. А значит выборка однородна. Значит, наши предположения о выбросах на основе графического представления выборки не подтвердились проверкой критерия \cite{Grubbs1950Sample}.

В соответствии с результатами проверки критериев и на основе построенных гистограммы и графика квантилей, можно сделать заключение о том, что распределение температуры воды озера Баторино в июле 1975--2009 годов является близким к нормальному закону распределения с параметрами $\mathcal{N}(19.88, 4.91)$. Что подтверждается коэффициентами асимметрии и эксцесса из таблицы \ref{table:dstats}, а также результатами, полученными мной при исследовании в пакете \textbf{STATISTICA}. Следует также отметить, что такие же результаты были получены и для всей выборки.

% section analysis (end)

\section{Корреляционный анализ} % (fold)
\label{sec:corr_analysis}

Исследуем теперь зависимость температуры воды от времени, построив диаграмму рассеяния и вычислив коэффициент корреляции соответствующих переменных.

Диаграммы рассеяния используются для визуального исследования зависимости между двумя переменными. Если переменные сильно связаны, то множество точек данных принимает определённую форму. С помощью таких диаграмм можно наглядно изучить знак коэффициента корреляции. Если точки на диаграмме расположены хаотически, то это говорит о независимости рассматриваемых переменных. Если с ростом переменной $t$ возрастает переменная $x$ то имеет место положительная корреляция. Если же с ростом переменной $t$ переменная $x$ убывает, то это указывает на отрицательную корреляцию. 
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/06_scatterplot.png}}
\caption{Диаграмма рассеяния}
\label{img:scatterplot}
\end{figure}

Из рисунка \ref{img:scatterplot} видно, что точки образуют своеобразное <<облако>>, ориентированное по диагонали вверх, то есть присутствует некая зависимость между рассмтриваемыми переменными. Также, данная диаграмма наглядно показывает силу этой зависимости: так как точки не образуют чёткой формы, а разбросаны относительно диагонали, то можно говорить о наличии умеренной корреляции. То есть, нельзя сказать, что зависимость сильная, но и нельзя сказать, что связь между переменными отсутствует.

Проверим полученные результаты подробнее. Для начала построим корреляционную матрицу.
\input{../out/cmatrix.tex}
Как видно из таблицы \ref{table:cmatrix}, коэффициент корреляции $r_{xt} = 0.47$. Этим подтверждаются наши выводы из диаграмм рассеяния и концентрации о положительной корреляции, поскольку полученный коэффициент корреляции является положительным и из таблицы \ref{table:corr}, присутствует умеренная зависимость: $r_{xt} \approx 0.5$. 

Оценим значимость полученного выборочного коэффициента корреляции с помощью возможностей пакета \textbf{R} и описанного ранее в параграфе критерия значимости. Вычислим:
\begin{equation*}
	T_{\textrm{набл}} = \frac{r_{xt} \sqrt{n - 2}}{\sqrt{1 - r_{xt}^2}} \approx 3.05885.
\end{equation*}
Рассмотрим уровень значимости $\alpha = 0.05$. Число степеней свободы $k = n - 2 = 36$. Тогда из таблицы критических точек распределения Стьюдента $t_\textrm{кр}(\alpha, k) \approx 2.03$. Следовательно,
\begin{equation*}
	T_{\textrm{набл}} > t_\textrm{кр}(\alpha, k).
\end{equation*}
Значит нулевую гипотезу о равенстве нулю коэффициента корреляции генеральной совокупности следует отклонить.

Пакет \textbf{R} предоставляет с помощью функции \textit{cor.test} различные методы для проверки значимости выборочного коэффициента корреляции. Воспользуемся проверкой теста методом Пирсона:
\input{../out/ctest.tex}
Как видно из полученных результатов $p-value < 0.05$, следовательно это говорит, о том, что необходимо отвегнуть гипотезу $H_0: r = 0$.

Значит, нулевую гипотезу о равенстве нулю коэффициента корреляции генеральной совокупности отвергаем и подтверждаем правильность полученных с помощью \textbf{R} результатов. Другими словами, выборочный коэффициент значимо отличается от нуля, т.е. температура воды и время при уровне значимости $\alpha = 0.05$ имеют зависимость.

Следует также отметить, что аналогичный анализ, проведённый в пакете STATISTICA, аналогичным образом выявил зависимость между температурой воды и временем.

Следовательно, в рассматриваемом случае можно говорить о присутствии значимой зависимости между температурой воды в озере Баторино и временем. 

% section corr_analysis (end)

\section{Регрессионный анализ} % (fold)
\label{sec:regr_analysis}

Для введения последующих понятий анализа временных рядов воспользуемся \cite{Eddows1997}.

В отличие от анализа случайных выборок, анализ временных рядов основывается на предположении, что последовательные значения в файле данных наблюдаются через равные промежутки времени.

Большинство методов исследования временных рядов включает различные способы фильтрации шума, выделения сезонной и циклической составляющих, позволяющие увидеть регулярную составляющую более отчётливо.

Во временных рядах выделяют три составляющие:
\begin{enumerate}
	\item \textit{Тренд (тенденция развития) ($T$)} --- эволюционная составляющая, которая характеризует общее направление развития изучаемого явления и связанна с действием долговременных факторов развития. 
	\item \textit{Циклические ($K$), сезонные ($S$) колебания} --- это составляющие, которые проявляются как отклонения от основной тенденции развития изучаемого явления, и связанны с действие краткосрочных, систематических факторов развития. Циклические колебания состоят в том, что значения признака в течение какого-то времени возрастают, достигают определённого максимума, затем убывают, достигают определённого минимума, вновь возрастают до прежних значений и т.д. Эту составляющую можно выявить только по данным за длительные промежутки времени, например, в 10, 15 или 20 лет. Сезонные колебания --- это колебания, периодически повторяющиеся в некоторое определённое время каждого года, месяца, недели, дня. Эти изменения отчётливо наблюдаются на графиках рядов динамики, содержащих данные за период не менее одного года.
	\item \textit{Нерегулярная случайная составляющая (ошибка) ($E$)}, являющаяся результатом действия второстепенных факторов развития.
\end{enumerate}
Первые два типа компонент представляют собой детерминированные составляющие. Случайная составляющая образована в результате суперпозиции некоторого числа внешних факторов.

По типу взаимосвязи вышеперечисленных составляющих ряда динамики можно построить следующие модели временных рядов ($X$):

\begin{itemize}
	\item Аддитивная модель: $X = T + K + S + E$;
	\item Мультипликативная модель: $X = T \times K \times S \times E$.
\end{itemize}
Аддитивной модели свойственно то, что характер циклических и сезонных колебаний остаётся постоянным.

В мультипликативной модели характер циклических и сезонных колебаний остаётся постоянным только по отношению к тренду (т.е. значения этих составляющих увеличиваются с возрастанием значений тренда).

По причине того, что в данном случае мы рассматриваем один месяц в году на протяжении длительного периода, будем считать, что в нашем временном ряде циклическая и сезонная составляющие отсутствуют. Построим график временного ряда.

\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/07_ts.png}}
\caption{График временного ряда с линией регрессии}
\label{img:ts_regr}
\end{figure}

На полученном графике можно заметить явно выраженный линейный рост значений со временем --- он проиллюстрирован на графике прямой. Эта составляющая нашего временного ряда --- тренд. Из этого следует, что уравнение тренда имеет вид:
\begin{equation*}
	x = at + b.
\end{equation*}

Продолжая рассуждение, как наблюдение из графика, можно отметить, что не происходит увеличения амплитуды колебаний с течением времени. А значит, данная модель является аддитивной. Из всего вышесказанного можно заключить, что модель исходного временного ряда имеет вид:
\begin{equation*}
	X = T + E.
\end{equation*}

В \textbf{R} реализованы функции, позволяющие подгонять линейные модели к исследуемым данным \cite{Shumway2006Time}. Одной из таких функций является \textit{lm(Fitting Linear Model)}. Она позволяет получить коэффициенты линии регрессии(тренд), остатки после удаления тренда. Коэффицинты, полученные с помощью данной функции представлены в \eqref{eq:regr_coeff}.
\begin{equation}
\label{eq:regr_coeff}
	a = 0.1014, \quad b = 18.0521.
\end{equation}
Следует отметить, что в пакете \textbf{STATISTICA} похожая процедура была проведена для всей выборки с помощью инструмента \textit{Trend Subtract}, результатом было уравнение: $y=17.98+0.108t$. Что согласуется с полученными в \textbf{R} коэффициентами. Отметим также, что эти результаты подтверждаются вычислениями в \textbf{Excel}.

Таким образом получена линейная модель, описывающая тенденцию развития:
\begin{equation}
\label{eq:regr}
	x = at + b = 0.1014t + 18.0521
\end{equation}

На основе полученной линейной модели \eqref{eq:regr}, построим ряд остатков(приложение \ref{c:app_results}, таблица \ref{table:residuals}), удалив тренд из исходного ряда. Полученный ряд представлен на рисунке \ref{img:ts_detrended}.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/08_residuals.png}}
\caption{График ряда остатков}
\label{img:ts_detrended}
\end{figure}


Проведём анализ полученной регрессионной модели. Для этого проверим значимость полученных коэффициентов регрессии и оценим адекватность регрессионной модели.

Рассчитаем вспомогательные величины, воспользовавшись введёнными ранее в параграфе \ref{c:theory} материалами. Дисперсия отклонения
\begin{equation*}
	\sigma_{\varepsilon}^2 \approx 3.823,
\end{equation*}
стандартные случайные погрешности параметров $a, b$:
\begin{equation*}
	\sigma_{a} \approx 0.029, \quad \sigma_{b} \approx 0.356.
\end{equation*}

Воспользуемся приведённым ранее критерием значимости коэффициентов линейной регрессии. Примем уровень значимости $\alpha = 0.05$, тогда
\begin{equation*}
	T_{a} = 38.2, \quad T_{b} = 50.5.
\end{equation*}

Число степеней свободы $k = 36$, $t_{\textrm{кр}}(k, \alpha) = 2.028$.

\begin{itemize}
	\item $\vert T_{a} \vert > t_{\textrm{кр}}$ $\Rightarrow$ коэффициент $a$ значим.
	\item $\vert T_{b} \vert > t_{\textrm{кр}}$ $\Rightarrow$ коэффициент $b$ значим.
\end{itemize}
Следовательно, при уровне значимости $\alpha = 0.05$, коэффициенты линейной регрессии являются значимыми.

Оценим адекватность полученной регрессионной модели. Дисперсия модели:
\begin{equation*}
	\overline{\sigma^2} \approx 1.44.
\end{equation*}

Остаточная дисперсия:
\begin{equation*}
	\overline{D} \approx 3.7.
\end{equation*}

Воспользуемся F-критерием Фишера. Пусть уровень значимости $\alpha = 0.05$,
\begin{equation*}
	F_{\textrm{крит}} \approx 14.01,
\end{equation*}
при степенях свободы $v_1 = 1, v_2 = 36, F_{\textrm{табл}}(v_1, v_2, \alpha) = 4.11$.

\begin{equation*}
	F_{\textrm{крит}} > F_{\textrm{табл}}.
\end{equation*}
Следовательно, при уровне значимости $\alpha = 0.05$, регрессионная модель является адекватной.

Рассчитаем коэффициент детерминации:
\begin{equation*}
	\eta_{x(t)}^2 \approx 0.275.
\end{equation*}

Проверим отклонение от линейности: $\eta_{x(t)}^2 - r_{xt}^{2} \approx 0.0044 \le 0.1$. Следовательно отклонение от линейности незначительно. Но при этом коэффициент детерминации оказался не достаточно высоким($<0.7$), это говорит о том, что построенная регрессионная модель не описывает в достаточной мере поведение временного ряда. Это, в свою очередь, может значить, что изменение температуры зависит не только от времени, но ещё и от каких-то других, неучтённых, факторов.

Тем не менее, попробуем построить прогноз по полученной модели. Вычисленые прогнозные значения на 2010-2012 годы: $21.87$ – 2010 год, $21.98$ – 2011 год, $22.08$ – 2012 год. Фактические данные на этот период: $24.3$, $22.8$, $20.2$ соответственно. Имеющееся отклонение прогнозов от реальных данных еще раз подтверждает, что построенная модель временного ряда обладает невысокой точностью.

Проанализируем временной ряд остатков. Для этого проверим свойства, которым должна удовлетворять нерегулярная составляющая $\varepsilon$:
\begin{enumerate}
	\item $E(\varepsilon) = 0$.
	\item Дисперсия $\varepsilon$ постоянна для всех значений.
	\item Остатки независимы и нормально распределены.
\end{enumerate}
Вычислим описательные статистики для остатков. Полученные результаты проследим по таблице \ref{table:resid_dstats}.
\input{../out/residuals_dstats.tex}

Как видно из таблицы \ref{table:resid_dstats}, среднее значение равно нулю. При этом коэффициенты асимметрии($A_S \approx 0.37$) и эксцесса($K \approx -0.87$) указывают на отклонение распределения остатков от нормального закона. 

Построим гистограмму и график квантилей для проверки последних заключений.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/09_res-hist-dnorm.png}}
\caption{Гистограмма остатков с кривой плотности нормального распределения}
\label{img:resid_hist}
\end{figure}
Гистограмма наглядно демонстрирует полученные в таблице \ref{table:resid_dstats} коэффициенты асимметрии и эксцесса. 

Для проверки нормальности построим график квантилей.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/10_res-qq.png}}
\caption{График квантилей для остатков}
\label{img:resid_qqnorm}
\end{figure}
На рисунке \ref{img:resid_qqnorm} можно заметить, что присутствуют скачки относительно нормального распределения. Наиболее явный из них --- нижний хвост. Остальные --- небольшие скачки по ходу линии нормального распределения. Проверим с помощью критерия Шапиро-Уилка, можно ли считать полученные остатки нормально распределёнными.
\input{../out/residuals_shapiro.tex}
В полученных результатах $W$ --- статистика Шапиро-Уилка. Вероятность ошибки $p = 0.124 > 0.05$, а значит нулевая гипотеза не отвергается. Следовательно опровергнуть предположение о нормальности на основе данного теста нельзя.

\bigskip
\bigskip
Проверим критерий $\chi^2$ Пирсона:
\bigskip
\input{../out/residuals_pearson.tex}
В полученных результатах $P$ --- статистика $\chi^2$ Пирсона. Вероятность ошибки $p = 0.1046 > 0.05$, а значит нулевая гипотеза не отвергается. Но при этом, это значение очень близко к $0.05$. Проверим критерий: примем уровень значимости $\alpha = 0.05$, тогда из таблицы распределения $\chi^2$ найдём критическое значение критерия $\chi_{\textrm{кр}}^2(\alpha, k) \approx 43.8$. Отсюда следует, что
\begin{equation*}
	\chi_{\textrm{набл}}^2 < \chi_{\textrm{кр}}^2,
\end{equation*}
где $\chi_{\textrm{набл}}^2 = P = 10.5143$. А значит, гипотезу о нормальности не отклоняем. 

Построим график автокорреляционной функции для определения наличия взаимосвязей в ряде остатков (рисунок \ref{img:resid_acf}). На графике пунктирные линии разграничивают значимые и не значимые корреляции: значения, выходящие за линии, являются значимыми \cite[с.376]{Teetor2011R}.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/11_acf.png}}
\caption{График автокорреляционной функции}
\label{img:resid_acf}
\end{figure}
На представленном графике автокорреляционной функции можно заметить на лаге $15$ значение, выходящее за интервал, обозначенный пунктирными линиями. Проверим значимость автокорреляций с помощью теста Льюнга-Бокса \cite[с.377-378]{Teetor2011R}. Данный тест проверяет наличие автокорреляций в исследуемом ряде.
\input{../out/residuals_ljung.tex}
В результатах теста $p > 0.05$, что говорит о том, что тест не выявил значимых автокорреляций.

На рисунке \ref{img:resid_acf} также можно заметить затухание с увеличением лага. На основе этого можно сделать предположение о стационарности. Для проверки этого предположения воспользуемся расширенным тестом Дики--Фуллера(ADF) \cite{Dickey1979Distribution}. 
\input{../out/residuals_stationarity.tex}
Как видно из результатов проверки теста, $p < 0.05$. Следовательно, необходимо принять альтернативную гипотезу о стационарности.

Полученная модель получилась неоднозначной, с одной стороны, полученное значение коэффициента детерминации показало недостаточную точность полученной модели и не удалось достоверно показать нормальность ряда остатков. С другой стороны, была показана стационарность и отсутствие автокорреляции. Поэтому возникает необходимость строить модель другими методами.

% section regr_analysis (end)

\section{Вариограммный анализ. Кригинг.} % (fold)
\label{sec:_variogram}

В данной части работы для более точного оценивания полученных прогнозов возьмем в качестве исследуемой выборки первые $32$ значения исходных данных.

Традиционные детерминированные методы, широко используемые в задачах прогнозирования, в большинстве случаев на практике не позволяют в полной мере решить ту или иную задачу. В наиболее благоприятных вариантах исследований они позволяют оценивать значения в точках, в которых измерения не проводились и определять значения на плотной сетке (в близких к измерениям точках). Следует также отметить, что данные измерений, как правило, дискретны и пространственно неоднородно распределены. В свою очередь, анализ этих данных и его результаты в значительной мере зависят как от качества так и от количества исходных данных. И именно такие выводы были сделаны в результате проделанной в предыдущих частях данной работы. Отсюда следует, что необходимо использовать другие современные методы, позволяющие сделать более точные модели и выводы.

Для поставленной задачи в современных исследованиях хороших результатов позволяет добиться методы геостатистики, что подтверждается работами [трататата]. Современная геостатистика --- это широкий спектр статистических моделей и инструментов для анализа, обработки и представления пространственно-распределенной информации.


В рамках геостатистики, для получения наилучшей в статистическом смысле пространственной оценки используются модели из семейства кригинга (\textit{kriging}) --- наилучшего линейного несмещенного оценивателя (\textit{Best Linear Unbiased Estimator --- BLUE}). Кригинг является ``наилучшим'' оценивателем в статистическом смысле --- его оценка обладает минимальной дисперсией. Важным свойством кригинга является точное воспроизведение значений измерений в имеющихся точках (интерполяционные свойства). В отличие от многочисленных детерминированных методов оценка кригинга сопровождается оценкой ошибки интеполяции в каждой точке. Полученная ошибка позволяет охарактеризовать неопределенность интерполяционноий оценки данных при помощи доверительных интервалов.

В отличие от детерминированных методов, геостатистические оценки опираются на информацию о внутренней структуре данных, зависят от самих данных, т. е. являются адаптивными.

Центральная идея геостатистики состоит в использовании знаний о пространственной корреляции экспериментальных данных для построения пространственных оценок и интерполяций. Вариограмма --- ключевой инструмент для оценки степени пространственной корреляции, имеющейся в данных, и для ее моделирования. Модель вариограммы является функцией, определяющей зависимость изменения исследуемой величины в пространстве от расстояния. Следовательно, интерполяционная модель, основанная на такой корреляционной функции, будет отражать реальные явления, которые лежат в основе данных измерений. Всевозможные пары точек могут быть рассортированы по классам в соответствии с разностью их координат $h = x_i - x_j$, называемой \textit{лагом}. Для близких точек разность значениеq функции в них обычно меньше и растет с увеличением расстояния между точками. Вычислив среднее значение квадратов разностей для каждого значения лага $h$ (для каждого собранного класса пар измерений), можно получить дискретную функцию, называемую \textit{экспериментальной вариограммой}. Вариограмма обычно характеризуется тремя значениями: эффект самородков(\textit{nugget}), ранг(\textit{range}) и порог(sill). Эффект самородков характеризуется разрывом вариограммы около нуля. Порог характеризует предельное значение вариограммы, на некотором расстоянии, называемом рангом, за которым последующие значения вариограммы становятся некоррелированными.

Также при построении вариограммы следует учитывать параметр максимального расстояния, для которого вычисляется вариограмма. Первоначальным параметром было выбрано следующее значение: $2n/3=23$.
%[Cressie, N.A.C., 1993, Statistics for Spatial Data, Wiley.;Cressie, N., C. Wikle, 2011, Statistics for Spatio-temporal Data, Wiley.]
Построим экспериментальную вариограмму с помощью пакета ``gstat'' и функции ``variogram''. С помощью этой функции можно построить экспериментальную вариограмму, основанную на классической оценки вариограммы и робастной оценки Кресси. Построим экспериментальную вариограмму с помощью классической оценки.

\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/13_classical-emp.png}}
\caption{Экспериментальная вариограмма}
\label{img:classical_emp}
\end{figure}

Построенная вариограмма отображена на рисунке \ref{img:classical_emp}. На представленном рисунке можно заметить, что на промежутке $[0;1]$ не происходит роста значений вариограммы. Наоборот, наблюдается разрыв: первое значение находится значительно выше $0$. При этом вариограмма не сильно выходит за пределы дисперсии переменной, которая равна $3.9$. Более того, первые значения уже достигло порога. Что говорит о том, что вариограмма на первых значениях выходит на предельное значение, и последующие значения некоррелированы. Это, на самом деле, согласуется с нашими исходными данными, так как при анализе остатков было выявлено отстутсвие автокорреляций и спецификой самих данных: наблюдение за каждый год, вообще говоря, не зависит от предшедствующего.

На основе этого делаем вывод о наличии эффекта самородков и делаем первоначальное предположение о равенстве порога $3.9$.

На основе экспериментальной вариограммы построим модель вариограммы для дальнейшего использования на этапе кригинга. Моделью вариограммы может служить не каждая функция, а только та, для которой выполнено условие положительной определенности. Положительная определенность модели вариограммы гарантирует, что уравнения кригинга, построенные с использованием данной модели, имеют единственное устойчивое решение. Поэтому при моделировании используются только те функции, для которых положительная определенность установлена, а также их взвешенные линейные комбинации с неотрицательными весами, которые тоже будут являться положительно определенными. Модель вариограммы строится как линейная комбинация подходящих базисных моделей.

Для построения моделей вариограммы существует два подхода: вручную, т.е. визуально с ручным подбором параметров, и автоматическим подбором параметров с помощью специальных методов. И на практике построение модели вариограммы  представляет собой итеративный процесс, на каждом шаге которого следует наилучшим образом подобрать параметры очередного модельного приближения. В различной литературе рекомендуется строить моделей вручную, так как исследователь лучше знает специфику данных, чем различные методы оценивания. Попробуем построить модель вариограммы визуально.

Ранее было отмечено присутствие эффекта самородков. Другой, часто встречающейся моделью, является сферическая: 
\begin{equation}
	\gamma(\vert h \vert) = c Sph_a(\vert h \vert) = \left\{
 \begin{array}{l l}
   c(1.5 \vert h \vert / a - 0.5(\vert h \vert / a)^3) &, \vert h \vert \le a, \\
   \\
   c &,	 \vert h \vert > a.
 \end{array} \right.	
\end{equation}

Возьмём эту модель в качестве базовой с помощью функции \textit{vgm}, в качестве начального параметра возьмём порог, указанный ранее: $3.9$. Далее воспользуемся функцией \textit{fit.variogram} для подбора более точных значений указанной модели. Таким образом окончательная модель:
\input{../out/manual_model.tex}
И график полученной модели на рисунке \ref{img:var-models} (пунктиром). На графике можно проследить все указанные ранее особенности: эффект самородков и порог.
\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/14_var_models.png}}
\caption{Модели классической вариограммы}
\label{img:var-models}
\end{figure}

Задача геостатистики --- оценить значения изучаемой пространственной переменной в произвольных точках области исследования на основе анализа ее значений, измеренных в ограниченном числе выборочных точек. По построенной модели вычислим оценки при помощи ординарного кригинга, реализованного функцией ``krige''. Вычисленные значения: $0.01228368, 0.01382626, 0.01382626, 0.01382626, 0.01382626, 0.01382626$. Оценку отклонения от истинных значений выразим с помощью среднеквадратической ошибки \textit{(MSE)}. В данном случае $MSE=2.636708$. Полученные значения оказались очень близкими к нулю и, начиная со второго значения значения не изменяются. Следовательно прогноз почти не изменился. Это говорит о том, что построенная модель не смогла уловить поведение исходных данных. По этой причине был использован второй вариант построения модели --- автоматический.

Для построения модели вариограммы была реализована возможность автоматического подбора модели на основе функции ``fit.variogram''. Суть этого подхода заключается в следующем: при заданных начальных условиях (эффект самородков, ранг, порог), для всех возможных базисных моделей подгонялись их параметры, для этих моделей вычислялись сумма квадратов ошибок, и на основе этого показателя выбиралась наиболее эффективная модель. Код программы в листинге \ref{lst:main}.

На рисунке \ref{img:var-models} сплошной линией показан результат выполнения представленной ранее функции. Таким образом, наилучшей моделью вариограммы, построенной по классической оценке, стала линейная комбинация двух: эффект самородков с параметром $3.130070$ и модель с эффектом дырок (\textit{Hole}) с параметрами: порог --- $1.219741$, ранг --- $0.3686477$.

Кригинг в этом случае построил следующие прогнозные значения: $0.123192458, -0.100531208, 0.130358294, -0.072544498, 0.076113473, -0.003595666$. Полученные значения отличаются от предыдущих, в них есть некоторое поведения. Но в данном случае $MSE=2.8752$. А значит, прогноз ухудшился.
Попробуем улучшить результат с помощью робастной оценки Кресси.

\begin{figure}[ht]
\center{\includegraphics[width=1\linewidth]{../figures/18_robust-mod.png}}
\caption{Теоретическая вариограмма (робастная оценка)}
\label{img:robust-mod}
\end{figure}

Модель вариограммы, представленная на рисунке \ref{img:robust-mod}, является также линейной комбинацией двух базисных моделей: эффекта самородков с параметром $4.6175154$ и модель с эффектом дырок с параметрами: $0.4736754$, $4.318585$. Заметим, что эмпирическая вариограмма, построенная по робастной оценке, отличается от соотвествующей вариограмм, построенных по классической оценке. Появилось заметное поведение вариограммы, в отличие от предыдущей, где значения концентрировались около дисперсии выборки.

Результаты кригинга показали следующие прогнозные значениея: $-0.10273199, 0.07493855, 0.15517704, 0.13209470, 0.05161946, -0.02323001$. Среднеквадратическая ошибка $MSE=2.368255$, что является наименьшей из полученных для заданных параметров. Таким образом, наилучшая оценка получена с помощью робастной оценки.

\begin{figure}[H]
\center{\includegraphics[width=1\linewidth]{../figures/check-dep.png}}
\caption{Зависимость ошибки от максимального расстояния}
\label{img:check-dep}
\end{figure}

Исследуем теперь поведение кригинга при различных параметрах максимального значения вариограммы. В качестве оценки качества полученного прогноза возьмем среднеквадратическую ошибку. Чем меньше ошибка --- тем лучше прогноз. Для этих целей реализована функция \textit{checkDepByMSE}. Результат её работы на рисунке \ref{img:check-dep}. На этом графике четко видно, что робастная оценка (пунктир-точка), в отличие от классической (пунктир) и модели, построенной вручную (сплошная), в большинстве случаев даёт более точные прогнозы. И наилучший при максимальном расстоянии равным $6$. С этим параметром, наилучший прогноз составляют значения кригинга: $-0.39594965, -0.03720509,  0.26603554,  0.40557237,  0.35386938  0.16726908$. Среднеквадратическая ошибка составляет $1.805819$. 

% \begin{figure}[H]
% \center{\includegraphics[width=1\linewidth]{../figures/22_cross-prediction-robust-best.png}}
% \caption{Сравнение прогнозных значений}
% \label{img:cross-prediction-best}
% \end{figure}

% Сравнительный анализ полученного прогноза на графике \ref{img:cross-prediction-best}.

Таким образом в результате вариограммного анализа были исследованы различные модели вариограмм, оценки, проведены два подхода по вычислению. В результате кригинга построена наилучшая модель прогнозных значений. Которая в свою очередь имеет погрешность в пределах стандартного отклонения. Следовательно данная модель является хорошим вариантом для построения прогнозных значений.
% section _variogram (end)